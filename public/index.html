<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة الحروف</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <script>
        // إخفاء phoneScreen إذا وُجد sessionCode بعد تحميل DOM
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionCode = urlParams.get('sessionCode');
            const phoneScreen = document.getElementById('phoneScreen');
            const loadingScreen = document.getElementById('loadingScreen');
            if (phoneScreen && loadingScreen) {
                if (sessionCode) {
                    phoneScreen.classList.remove('active');
                    loadingScreen.classList.add('active');
                } else {
                    phoneScreen.classList.add('active');
                    loadingScreen.classList.remove('active');
                }
            }
        });
    </script>
</head>
<body>
    <div id="offlineMessage" style="display: none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #dc3545; color: #fff; padding: 10px; border-radius: 5px;">
        أنت غير متصل بالإنترنت. بعض الوظائف قد لا تعمل.
    </div>
    <div class="container">
        <div id="loadingScreen" class="loading-screen" style="display: none;">
            <div class="spinner"></div>
            <p>جاري التحميل...</p>
        </div>
        <div class="phone-screen" id="phoneScreen">
            <h2>أدخل رمز الجلسة</h2>
            <input type="text" id="phoneNumber" placeholder="مثال: X7K9P2">
            <button id="submitPhoneButton">تأكيد</button>
            <div id="announcementsContainer"></div>
            <div id="connectionLost" class="connection-lost" style="display: none;">
                <div class="spinner"></div>
                <p>جاري إعادة الاتصال...</p>
                <button id="connectionLostButton" onclick="resetToPhoneScreen()" style="display: none;">العودة للجلسة</button>
            </div>
            <p id="phoneError" class="error-message"></p>
        </div>

        <div class="welcome-screen" id="welcomeScreen">
            <h2>مرحبًا بك في لعبة الحروف!</h2>
            <input type="text" id="playerName" placeholder="أدخل اسمك">
            <div>
                <button id="hostButton">مضيف</button>
                <button id="contestantButton">متسابق</button>
            </div>
            <p id="welcomeError" class="error-message"></p>
            <div id="welcomeAnnouncementsContainer"></div>
            <div id="adminPanel" style="display: none; margin-top: 20px;">
                <h3>إدارة الرموز</h3>
                <p id="codesCount" class="stats">إجمالي عدد الرموز: 0</p>
                <input type="number" id="codeCount" placeholder="عدد الرموز المطلوبة" min="1" max="5000">
                <button id="generateCodesButton">توليد الرموز</button>
                <button id="copyCodesButton" style="display: none;">نسخ الرموز</button>
                <input type="number" id="specialCodeCount" placeholder="عدد الرموز الخاصة" min="1" max="5000">
                <button id="generateSpecialCodesButton" style="background-color: #28a745; color: #fff;">توليد رموز خاصة</button>
                <button id="copySpecialCodesButton" style="background-color: #28a745; color: #fff; display: none;">نسخ الرموز الخاصة</button>
                <textarea id="specialGeneratedCodes" readonly style="margin-top: 10px; width: 100%; height: 100px; resize: none;"></textarea>
                <br>
                <input type="text" id="manualCode" placeholder="إضافة رمز يدويًا">
                <button id="addManualCodeButton">إضافة الرمز</button>
                <br>
                <input type="text" id="deleteCode" placeholder="حذف رمز">
                <button id="deleteCodeButton">حذف الرمز</button>
                <br>
                <textarea id="deleteCodesList" placeholder="أدخل قائمة الرموز للحذف (كل رمز في سطر)"></textarea>
                <button id="deleteCodesListButton">حذف القائمة</button>
                <br>
                <input type="number" id="deleteLatestCount" placeholder="عدد الرموز الأحدث للحذف">
                <button id="deleteLatestCodesButton">حذف الأحدث</button>
                <br>
                <button id="backupButton" class="backup-btn">نسخ الرموز</button>
                <input type="file" id="restoreFile" accept=".xlsx" style="display: none;">
                <button id="restoreButton" class="backup-btn">إدخال رموز</button>
                <p id="adminStatus" style="color: #fff;"></p>
                <p id="adminError" class="error-message"></p>
                <div class="announcement-management">
                    <h3>إدارة الإعلانات</h3>
                    <input type="text" id="announcementTitle" placeholder="عنوان الإعلان (اختياري)">
                    <textarea id="announcementText" placeholder="نص الإعلان (اختياري)" style="width: 100%; height: 100px; resize: none;"></textarea>
                    <input type="url" id="announcementLink" placeholder="رابط الإعلان (اختياري)">
                    <input type="text" id="announcementButtonText" placeholder="اسم الزر (اختياري)">
                    <button id="addAnnouncementButton">إضافة الإعلان</button>
                    <div id="announcementsList" class="questions-container"></div>
                </div>
                <p id="questionsCount" class="stats"></p>
                <div id="generatedCodes" style="margin-top: 10px;"></div>
                <h3>إدارة الأسئلة العامة</h3>
                <input type="text" id="newGeneralQuestion" placeholder="أدخل السؤال">
                <input type="text" id="newGeneralAnswer" placeholder="أدخل الإجابة">
                <select id="generalQuestionLetter">
                    <option value="">اختر حرف</option>
                    <option value="أ">أ</option><option value="ب">ب</option><option value="ت">ت</option><option value="ث">ث</option>
                    <option value="ج">ج</option><option value="ح">ح</option><option value="خ">خ</option><option value="د">د</option>
                    <option value="ذ">ذ</option><option value="ر">ر</option><option value="ز">ز</option><option value="س">س</option>
                    <option value="ش">ش</option><option value="ص">ص</option><option value="ض">ض</option><option value="ط">ط</option>
                    <option value="ظ">ظ</option><option value="ع">ع</option><option value="غ">غ</option><option value="ف">ف</option>
                    <option value="ق">ق</option><option value="ك">ك</option><option value="ل">ل</option><option value="م">م</option>
                    <option value="ن">ن</option><option value="ه">ه</option><option value="و">و</option><option value="ي">ي</option>
                </select>
                <button id="addGeneralQuestionButton">إضافة سؤال عام</button>
                <input type="file" id="excelFile" accept=".xlsx">
                <button id="uploadExcelButton">رفع ملف Excel</button>
                <select id="generalLetterFilter">
                    <option value="">جميع الحروف</option>
                    <option value="أ">أ</option><option value="ب">ب</option><option value="ت">ت</option><option value="ث">ث</option>
                    <option value="ج">ج</option><option value="ح">ح</option><option value="خ">خ</option><option value="د">د</option>
                    <option value="ذ">ذ</option><option value="ر">ر</option><option value="ز">ز</option><option value="س">س</option>
                    <option value="ش">ش</option><option value="ص">ص</option><option value="ض">ض</option><option value="ط">ط</option>
                    <option value="ظ">ظ</option><option value="ع">ع</option><option value="غ">غ</option><option value="ف">ف</option>
                    <option value="ق">ق</option><option value="ك">ك</option><option value="ل">ل</option><option value="م">م</option>
                    <option value="ن">ن</option><option value="ه">ه</option><option value="و">و</option><option value="ي">ي</option>
                </select>
                <div id="generalQuestionsList" class="questions-container"></div>
                <button id="deleteGeneralQuestionsButton">حذف الأسئلة المحددة</button>
                <h3>أسئلة الجلسات</h3>
                <select id="sessionLetterFilter">
                    <option value="">جميع الحروف</option>
                    <option value="أ">أ</option><option value="ب">ب</option><option value="ت">ت</option><option value="ث">ث</option>
                    <option value="ج">ج</option><option value="ح">ح</option><option value="خ">خ</option><option value="د">د</option>
                    <option value="ذ">ذ</option><option value="ر">ر</option><option value="ز">ز</option><option value="س">س</option>
                    <option value="ش">ش</option><option value="ص">ص</option><option value="ض">ض</option><option value="ط">ط</option>
                    <option value="ظ">ظ</option><option value="ع">ع</option><option value="غ">غ</option><option value="ف">ف</option>
                    <option value="ق">ق</option><option value="ك">ك</option><option value="ل">ل</option><option value="م">م</option>
                    <option value="ن">ن</option><option value="ه">ه</option><option value="و">و</option><option value="ي">ي</option>
                </select>
                <div id="sessionQuestionsList" class="questions-container"></div>
                <button id="addToGeneralButton">إضافة المحدد للعام</button>
            </div>
        </div>

        <div class="host-screen" id="hostScreen">
            <div class="hex-grid" id="hexGridHost">
                <div class="party-text" id="partyText">مبروك</div>
            </div>
            <div class="icon-container">
                <button id="shuffleButton" class="icon-btn" title="خلط"><i class="fas fa-random"></i></button>
                <button id="swapColorsButton" class="icon-btn" title="عكس الألوان"><i class="fas fa-exchange-alt"></i></button>
                <button id="changeColorsButton" class="icon-btn" title="تغيير الألوان"><i class="fas fa-palette"></i></button>
                <button id="partyButton" class="icon-btn party-btn" title="وضع الحفلة"><i class="fas fa-star"></i></button>
                <button id="shareButton" class="icon-btn" title="رابط العرض"><i class="fas fa-tv"></i></button>
                <button id="inviteFriendsButton" class="icon-btn" title="دعوة الأصدقاء"><i class="fas fa-user-friends"></i></button>
                <button id="saveButton" class="icon-btn save-btn" title="تثبيت التطبيق"><i class="fas fa-download"></i></button>
            </div>
            <div class="sliders-container">
                <label for="sizeSlider" style="color: #fff; font-size: 14px;">حجم اللوحة</label>
                <input type="range" id="sizeSlider" class="size-slider" min="40" max="100" value="100">
                <p style="color: #fff; font-size: 12px; margin-top: 5px;">ملاحظة: تغيير حجم النافذة سيعيد اللوحة إلى الحجم الطبيعي</p>
            </div>
            <p id="buzzerInfo" class="buzzer-info"></p>
            <div class="question-section">
                <p id="currentQuestion" style="flex: 100%; margin: 0;"></p>
                <button id="nextQuestionButton">السؤال التالي</button>
                <div class="toggle-container">
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggleQuestions" checked>
                        <span class="slider"></span>
                    </label>
                    <label class="toggle-label">استخدام الأسئلة العامة</label>
                </div>
                <input type="text" id="newQuestionInput" placeholder="أدخل السؤال">
                <input type="text" id="newAnswerInput" placeholder="أدخل الإجابة">
                <select id="questionLetter">
                    <option value="">اختر حرف</option>
                    <option value="أ">أ</option><option value="ب">ب</option><option value="ت">ت</option><option value="ث">ث</option>
                    <option value="ج">ج</option><option value="ح">ح</option><option value="خ">خ</option><option value="د">د</option>
                    <option value="ذ">ذ</option><option value="ر">ر</option><option value="ز">ز</option><option value="س">س</option>
                    <option value="ش">ش</option><option value="ص">ص</option><option value="ض">ض</option><option value="ط">ط</option>
                    <option value="ظ">ظ</option><option value="ع">ع</option><option value="غ">غ</option><option value="ف">ف</option>
                    <option value="ق">ق</option><option value="ك">ك</option><option value="ل">ل</option><option value="م">م</option>
                    <option value="ن">ن</option><option value="ه">ه</option><option value="و">و</option><option value="ي">ي</option>
                </select>
                <button id="addQuestionButton">إضافة سؤال</button>
            </div>
            <div class="players-container">
                <div class="team-list" id="redTeamList" ondragover="allowDrop(event)" ondrop="drop(event)"><h3>الفريق الأحمر</h3></div>
                <div class="team-list" id="greenTeamList" ondragover="allowDrop(event)" ondrop="drop(event)"><h3>الفريق الأخضر</h3></div>
            </div>
        </div>

        <div class="contestant-screen" id="contestantScreen">
            <div class="hex-grid" id="hexGridContestant">
                <div class="party-text" id="partyTextContestant">مبروك</div>
            </div>
            <p id="contestantBuzzerInfo" class="buzzer-info"></p>
            <button id="buzzerButton" class="buzzer-btn"><i class="fas fa-bell"></i></button>
            <div id="teamInfo" style="margin-top: 10px; color: #fff;"></div>
        </div>

        <div id="shareModal" class="share-modal">
            <div class="share-modal-content">
                <span id="closeModal" class="modal-close">×</span>
                <p>انسخ هذا الرابط وشاركه مع جهاز العرض</p>
                <div id="qrCode"></div>
                <div class="share-link-container">
                    <input type="text" id="shareLink" readonly>
                    <button id="copyLinkButton">نسخ الرابط</button>
                </div>
            </div>
        </div>
        <div id="inviteModal" class="share-modal">
            <div class="share-modal-content">
                <span id="closeInviteModal" class="modal-close">×</span>
                <p>انسخ رابط الدعوة أو شاركه مع الأصدقاء</p>
                <div id="inviteQrCode"></div>
                <div class="share-link-container">
                    <input type="text" id="inviteLink" readonly>
                    <button id="copyInviteLinkButton">نسخ الرابط</button>
                    <button id="shareInviteLinkButton">مشاركة</button>
                </div>
            </div>
        </div>
        <div id="installModal" class="share-modal" style="display: none;">
            <div class="share-modal-content">
                <span id="closeInstallModal" class="modal-close">×</span>
                <p id="installInstructions"></p>
            </div>
        </div>
    </div>

    <audio id="buzzerSound" src="/school-bell.mp3" preload="auto"></audio>
    <audio id="timeUpSound" src="/timeisup.mp3" preload="auto"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="script.js"></script>
</body>
</html>